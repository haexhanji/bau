<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>백석예대 영상학부 졸업준비위원회 (영화콘텐츠, 영상미디어)</title>
  <link rel="stylesheet" href="css/style.css"/>
  <style>
    .notice-actions{ display:flex; gap:8px; margin-top:8px; }
    .btn-del{ font-size:12px; padding:4px 8px; border:1px solid #ef4444; color:#ef4444; background:#fff; border-radius:8px; cursor:pointer }
    .btn-del:hover{ background:#fee2e2 }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner container">
      <button id="menutgl" class="mobonly menu" aria-label="메뉴">☰</button>
      <div class="title">백석예대 영상학부 졸업준비위원회 <span class="subtitle">(영화콘텐츠, 영상미디어)</span></div>
    </div>
  </header>

  <div class="container layout">
    <aside id="sidebar" class="sidebar">
      <a class="navbtn" data-route="movie" href="movie.html"><span>영화콘텐츠</span></a>
      <a class="navbtn" data-route="media" href="media.html"><span>영상미디어</span></a>
      <a class="navbtn" data-route="schedule" href="schedule.html"><span>전체일정</span></a>
      <a class="navbtn" data-route="notices" href="notices.html"><span>공지사항 모음</span></a>
      <div class="card" style="margin-top:12px">
        <div class="small"><b>공통 공지 </b><br/> 현재 졸업심사 관련 수요조사가 진행 중입니다.<br><br> 🔔 앞으로 모든 공지는 이 사이트에 업데이트됩니다.</div>
      </div>
    </aside>

    <main>
      <div class="container" style="margin:16px 0;">
        <button id="adminLogin" class="small">관리자 모드</button>
      </div>

      <div id="adminBox" class="card" style="display:none;">
        <h3>공지 업로드</h3>
        <form id="noticeForm">
          <div style="display:grid; gap:8px; grid-template-columns: 120px 1fr; align-items:center;">
            <label for="ndate">날짜</label>
            <input type="date" id="ndate" name="date" required/>
            <label for="ntitle">제목</label>
            <input type="text" id="ntitle" name="title" required/>
            <label for="nbody">본문</label>
            <textarea id="nbody" name="body" rows="6" required></textarea>
          </div>
          <div style="margin-top:12px; display:flex; gap:8px;">
            <button type="submit" class="primary">업로드</button>
            <button type="button" id="adminCancel">숨기기</button>
          </div>
        </form>
      </div>

      <div class="card">
        <h2>공지사항 모음</h2>
        <p class="muted">중요 공지를 빠르게 모아 확인할 수 있습니다.</p>
        <div id="noticeList"></div>
      </div>
    </main>
  </div>

  <footer class="footer">
    <div class="container small">
      © 2025 백석예대 영상학부 졸업준비위원회.
    </div>
  </footer>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyO4o5rlRJCynwnuQPUbW3ZSgODlmMl_jBNZXwHqBlOmhJaHv4GggYl8vwKbf1EzYNf/exec';
    let ADMIN_PWD = null;

    document.addEventListener('DOMContentLoaded', () => {
      const $date = document.getElementById('ndate');
      if ($date) {
        const t = new Date();
        const m = String(t.getMonth()+1).padStart(2,'0');
        const d = String(t.getDate()).padStart(2,'0');
        $date.value = `${t.getFullYear()}-${m}-${d}`;
      }
      loadNotices();
    });

    async function loadNotices(){
      try{
        const r = await fetch(`${SCRIPT_URL}?mode=list`, { cache:'no-store' });
        const items = await r.json();
        renderNotices(Array.isArray(items) ? items : []);
      }catch(e){ console.error(e); }
    }
    function renderNotices(items){
      const box = document.getElementById('noticeList');
      if(!items.length){
        box.innerHTML = '<div class="muted small">등록된 공지가 없습니다.</div>';
        return;
      }
      const isAdmin = !!ADMIN_PWD;
      box.innerHTML = items.map(it => `
        <div class="notice" data-id="${it.id}">
          <div class="date">${it.date}</div>
          <div class="title">${it.title}</div>
          <div class="body">${it.body}</div>
          ${isAdmin ? `<div class="notice-actions"><button class="btn-del" data-id="${it.id}">삭제</button></div>`:''}
        </div>
      `).join('');
    }

    document.getElementById('adminLogin')?.addEventListener('click', async () => {
      const pwd = prompt('관리자 비밀번호');
      if(!pwd) return;
      const r = await fetch(`${SCRIPT_URL}?mode=ping&pwd=${encodeURIComponent(pwd)}`);
      const j = await r.json();
      if(!j.ok) return alert('비밀번호 오류');
      ADMIN_PWD = pwd.trim();
      document.getElementById('adminBox').style.display='block';
      loadNotices();
    });
    document.getElementById('adminCancel')?.addEventListener('click', () => {
      document.getElementById('adminBox').style.display='none';
    });

    // 업로드
    document.getElementById('noticeForm')?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!ADMIN_PWD) return alert('관리자 인증 필요');
      const f=e.target;
      const body=new URLSearchParams({
        mode:'add', pwd:ADMIN_PWD, date:f.date.value, title:f.title.value, body:f.body.value
      });
      const r=await fetch(SCRIPT_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body});
      const j=await r.json();
      if(!j.ok) return alert('업로드 실패: '+j.error);
      alert('업로드 완료'); f.reset(); loadNotices();
    });

    // 삭제 (쿼리스트링으로 mode 전달)
    document.getElementById('noticeList')?.addEventListener('click', async (e)=>{
      const btn=e.target.closest('.btn-del'); if(!btn) return;
      if(!ADMIN_PWD) return alert('관리자 인증 필요');
      const id=btn.dataset.id;
      if(!confirm('정말 삭제할까요?')) return;
      const url=`${SCRIPT_URL}?mode=delete&id=${encodeURIComponent(id)}&pwd=${encodeURIComponent(ADMIN_PWD)}`;
      const r=await fetch(url,{method:'POST',body:''});
      const j=await r.json();
      if(!j.ok) return alert('삭제 실패: '+j.error);
      alert('삭제 완료'); loadNotices();
    });
  </script>
</body>
</html>
